# Copyright 2025 Flant JSC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

type: object
description: |
  User-facing configuration for the GPU Control Plane module. The fields below
  enable core GPU management scenarios while the rest of the behaviour relies
  on module defaults.
properties:
  highAvailability:
    type: boolean
    description: |
      Controls the high availability mode for controller and webhook workloads.

      * `true` — always run two replicas of each component regardless of the control plane topology.
      * `false` — force the module to stay in single-replica mode.
      * not set — allow the platform to auto-detect whether HA is required.
    x-examples: [true, false]
  managedNodes:
    type: object
    description: |
      Defines the node label that enables GPU management and whether nodes are treated as managed by default.
    properties:
      labelKey:
        type: string
        default: "gpu.deckhouse.io/enabled"
        description: |
          Node label examined by the module. A node is considered managed while the label value is not equal to the string `false`.
        x-examples: ["gpu.deckhouse.io/enabled"]
      enabledByDefault:
        type: boolean
        default: true
        description: |
          When `true`, every node is managed until the label is explicitly set to `false`. Toggle it to opt-in only selected nodes.
        x-examples: [true, false]
    additionalProperties: false
  deviceApproval:
    type: object
    description: |
      Approval policy applied to newly discovered GPU devices: manual review, fully automatic admission or a label-based selector.
    properties:
      mode:
        type: string
        default: "Manual"
        description: |
          Approval mode:
            * `Manual` — the controller keeps devices in a pending state until an operator acts.
            * `Automatic` — every device is approved immediately after discovery.
            * `Selector` — automatic approval is limited to devices that match the provided selector.
        enum:
          - Manual
          - Automatic
          - Selector
        x-examples: ["Manual", "Automatic", "Selector"]
      selector:
        type: object
        description: |
          Kubernetes LabelSelector applied when `mode=Selector`. Devices must satisfy the selector to get approved automatically.
        properties:
          matchLabels:
            type: object
            description: |
              Exact label/value pairs that must be present on the device.
            additionalProperties:
              type: string
          matchExpressions:
            type: array
            description: |
              Expression-based selector rules (`In`, `NotIn`, `Exists`, `DoesNotExist`) evaluated against device labels.
            items:
              type: object
              description: Single LabelSelector requirement.
              properties:
                key:
                  type: string
                  description: Label key evaluated by the requirement.
                operator:
                  type: string
                  description: Comparison operator used by the requirement.
                  enum:
                    - In
                    - NotIn
                    - Exists
                    - DoesNotExist
                values:
                  type: array
                  description: |
                    Set of label values used with `In`/`NotIn`. Must be empty for `Exists` and `DoesNotExist`.
                  items:
                    type: string
              additionalProperties: false
        additionalProperties: false
    additionalProperties: false
  scheduling:
    type: object
    description: |
      Default scheduling hints applied by controllers when new GPU pools or workloads are created without explicit settings.
    properties:
      defaultStrategy:
        type: string
        default: "Spread"
        description: |
          Placement strategy inherited by pools: `Spread` balances GPUs across zones, `BinPack` keeps workloads on the smallest number of nodes.
        enum:
          - BinPack
          - Spread
        x-examples: ["Spread", "BinPack"]
      topologyKey:
        type: string
        default: "topology.kubernetes.io/zone"
        description: |
          Kubernetes topology key used when `defaultStrategy=Spread`.
        x-examples: ["topology.kubernetes.io/zone"]
    additionalProperties: false
  monitoring:
    type: object
    description: |
      Monitoring integration options.
    properties:
      serviceMonitor:
        type: boolean
        default: true
        description: |
          Expose controller metrics to Deckhouse Prometheus (`true`) or disable the ServiceMonitor (`false`).
        x-examples: [true, false]
    additionalProperties: false
  inventory:
    type: object
    description: |
      Resync settings for the GPU inventory controller.
    properties:
      resyncPeriod:
        type: string
        pattern: '^\\d+(s|m|h)$'
        default: "30s"
        description: |
          Explicit resync interval expressed as a Go duration (`30s`, `1m`, `5m`, ...).
        x-examples: ["30s", "1m", "5m"]
    additionalProperties: false
  https:
    type: object
    description: |
      HTTPS configuration for module webhooks and auxiliary endpoints. Choose between self-signed certificates, a custom Secret or cert-manager automation.
    properties:
      mode:
        type: string
        default: "CertManager"
        enum:
          - Disabled
          - CertManager
          - CustomCertificate
          - OnlyInURI
        description: |
          HTTPS mode:
            * `CertManager` — obtain a certificate from the ClusterIssuer specified in `certManager.clusterIssuerName`.
            * `CustomCertificate` — mount an existing Secret from the `d8-system` namespace defined in `customCertificate.secretName`.
            * `OnlyInURI` — keep serving HTTP inside the cluster and only advertise HTTPS URLs (for external TLS termination).
            * `Disabled` — operate over plain HTTP.
      certManager:
        type: object
        description: |
          cert-manager settings, used only when `mode=CertManager`.
        properties:
          clusterIssuerName:
            type: string
            default: "letsencrypt"
            description: |
              Name of the ClusterIssuer that should sign the webhook certificate.
      customCertificate:
        type: object
        default: {}
        description: |
          Parameters for the custom certificate mode.
        properties:
          secretName:
            type: string
            description: |
              Name of the Secret in the `d8-system` namespace that contains `tls.crt`, `tls.key` and `ca.crt`.
    additionalProperties: false
