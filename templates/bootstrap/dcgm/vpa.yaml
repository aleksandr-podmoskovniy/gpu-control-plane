{{/* Copyright 2025 Flant JSC */}}
{{- $component := "dcgm" }}
{{- $moduleEnabled := eq (include "gpuControlPlane.isEnabled" .) "true" }}
{{- $componentEnabled := eq (include "gpuControlPlane.bootstrap.componentEnabled" (list . $component)) "true" }}
{{- $vpaEnabled := has "vertical-pod-autoscaler" (.Values.global.enabledModules | default (list)) }}
{{- if and $moduleEnabled $componentEnabled $vpaEnabled }}
{{- $namespace := include "gpuControlPlane.namespace" . }}
{{- $name := include "gpuControlPlane.bootstrap.componentName" (list . $component) }}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: {{ $name }}
  namespace: {{ $namespace }}
  {{- include "gpuControlPlane.bootstrap.moduleLabels" (list . $component "dcgm") | nindent 2 }}
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: DaemonSet
    name: {{ $name }}
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
      - containerName: dcgm
        minAllowed:
          cpu: 100m
          memory: 128Mi
        maxAllowed:
          cpu: 500m
          memory: 512Mi
{{- end }}
