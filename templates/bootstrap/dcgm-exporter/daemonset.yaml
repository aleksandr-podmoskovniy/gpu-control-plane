{{- if eq (include "gpuControlPlane.isEnabled" .) "true" }}
{{- $cfg := (dig "bootstrap" "dcgmExporter" .Values.gpuControlPlane) | default dict }}
{{- if ne (default true ($cfg.enabled)) false }}
{{- $namespace := include "gpuControlPlane.namespace" . }}
{{- $component := "dcgm-exporter" }}
{{- $name := include "gpuControlPlane.bootstrap.componentName" (list . $component) }}
{{- $image := include "helm_lib_module_image" (list . "nvidiaDcgmExporter") }}
{{- $port := (default 9400 $cfg.port) }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ $name }}
  namespace: {{ $namespace }}
  {{- include "gpuControlPlane.bootstrap.moduleLabels" (list . $component "dcgm-exporter") | nindent 2 }}
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app: {{ $name }}
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ $name }}
  namespace: {{ $namespace }}
  {{- include "gpuControlPlane.bootstrap.moduleLabels" (list . $component "dcgm-exporter") | nindent 2 }}
spec:
  selector:
    matchLabels:
      app: {{ $name }}
  template:
    metadata:
      {{- include "gpuControlPlane.bootstrap.moduleLabels" (list . $component "dcgm-exporter") | nindent 6 }}
    spec:
      serviceAccountName: {{ $name }}
      automountServiceAccountToken: true
      {{- include "helm_lib_module_pod_security_context_run_as_user_root" . | nindent 6 }}
      {{- include "helm_lib_priority_class" (tuple . "system-cluster-critical") | nindent 6 }}
      {{- include "gpuControlPlane.managedNodeTolerations" . | nindent 6 }}
      {{- include "gpuControlPlane.bootstrap.affinity" . | nindent 6 }}
      containers:
        - name: dcgm-exporter
          image: {{ $image }}
          imagePullPolicy: IfNotPresent
          command: ["/usr/bin/dcgm-exporter-entrypoint.sh"]
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: NVIDIA_DISABLE_REQUIRE
              value: "true"
            - name: NVIDIA_DRIVER_CAPABILITIES
              value: "compute,utility,compat32"
            - name: NO_SETCAP
              value: ""
            - name: DCGM_EXPORTER_LISTEN
              value: {{ printf ":%d" $port | quote }}
            - name: DCGM_EXPORTER_KUBERNETES
              value: "true"
            - name: DCGM_EXPORTER_COLLECTORS
              value: "/etc/dcgm-exporter/dcp-metrics-included.csv"
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          securityContext:
            privileged: true
            runAsNonRoot: false
            runAsUser: 0
            capabilities:
              add: ["SYS_ADMIN"]
          resources:
            requests:
              {{- include "helm_lib_module_ephemeral_storage_only_logs" . | nindent 14 }}
              cpu: 200m
              memory: 512Mi
          ports:
            - name: metrics
              containerPort: {{ $port }}
          volumeMounts:
            - name: pod-gpu-resources
              mountPath: /var/lib/kubelet/pod-resources
              readOnly: true
      volumes:
        - name: pod-gpu-resources
          hostPath:
            path: /var/lib/kubelet/pod-resources
            type: Directory
{{- end }}
{{- end }}
