{{/* Copyright 2025 Flant JSC */}}
{{- $component := "validator" }}
{{- $moduleEnabled := eq (include "gpuControlPlane.isEnabled" .) "true" }}
{{- $componentEnabled := eq (include "gpuControlPlane.bootstrap.componentEnabled" (list . $component)) "true" }}
{{- if and $moduleEnabled $componentEnabled }}
{{- $namespace := include "gpuControlPlane.namespace" . }}
{{- $validatorName := include "gpuControlPlane.bootstrap.componentName" (list . $component) }}
{{- $image := include "helm_lib_module_image" (list . "gpuValidator") }}
{{- $bootstrapCfg := dig "bootstrap" .Values.gpuControlPlane (dict) }}
{{- if not (kindIs "map" $bootstrapCfg) }}{{- $bootstrapCfg = dict }}{{- end }}
{{- $migStrategy := (index $bootstrapCfg "migStrategy") | default "single" }}
{{- $validatorCfg := (index $bootstrapCfg "validator") | default dict }}
{{- if not (kindIs "map" $validatorCfg) }}{{- $validatorCfg = dict }}{{- end }}
{{- $runtimeClass := (index $validatorCfg "runtimeClass") | default "nvidia" }}
{{- $validatorPullPolicy := "IfNotPresent" }}
{{- $enableNvidiaFS := (index $validatorCfg "enableNvidiaFSValidation") | default false }}
{{- $enableGDRCopy := (index $validatorCfg "enableGDRCopyValidation") | default false }}
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ $validatorName }}
  namespace: {{ $namespace }}
  {{- include "gpuControlPlane.bootstrap.moduleLabels" (list . $component "validator") | nindent 2 }}
spec:
  selector:
    matchLabels:
      app: {{ $validatorName }}
  template:
    metadata:
      {{- $hash := include "gpuControlPlane.bootstrap.componentHash" (list . $component) -}}
      {{- if $hash }}
      annotations:
        gpu.deckhouse.io/bootstrap-state-hash: {{ $hash | quote }}
      {{- end }}
      {{- include "gpuControlPlane.bootstrap.moduleLabels" (list . $component "validator") | nindent 6 }}
    spec:
      serviceAccountName: {{ $validatorName }}
      {{- include "helm_lib_module_pod_security_context_run_as_user_root" . | nindent 6 }}
      {{- include "helm_lib_priority_class" (tuple . "system-node-critical") | nindent 6 }}
      {{- include "gpuControlPlane.managedNodeTolerations" . | nindent 6 }}
      {{- include "gpuControlPlane.bootstrap.affinity" (list . $component) | nindent 6 }}
      initContainers:
        - name: driver-validation
          image: {{ $image }}
          imagePullPolicy: IfNotPresent
          command: ["/usr/bin/nvidia-validator"]
          {{- include "helm_lib_module_container_security_context_privileged_read_only_root_filesystem" . | nindent 10 }}
          env:
            - name: COMPONENT
              value: driver
            - name: WITH_WAIT
              value: "true"
            - name: HOST_ROOT
              value: /host
            - name: OUTPUT_DIR
              value: /run/nvidia/validations
            - name: OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          volumeMounts:
            - name: host-root
              mountPath: /host
              readOnly: true
              mountPropagation: HostToContainer
            - name: driver-install-dir
              mountPath: /run/nvidia/driver
              mountPropagation: HostToContainer
            - name: run-nvidia-validations
              mountPath: /run/nvidia/validations
              mountPropagation: Bidirectional
            - name: host-dev-char
              mountPath: /host-dev-char
        {{- if $enableNvidiaFS }}
        - name: nvidia-fs-validation
          image: {{ $image }}
          imagePullPolicy: IfNotPresent
          command: ["/usr/bin/nvidia-validator"]
          {{- include "helm_lib_module_container_security_context_privileged_read_only_root_filesystem" . | nindent 10 }}
          env:
            - name: COMPONENT
              value: nvidia-fs
            - name: WITH_WAIT
              value: "true"
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: OUTPUT_DIR
              value: /run/nvidia/validations
          volumeMounts:
            - name: run-nvidia-validations
              mountPath: /run/nvidia/validations
              mountPropagation: Bidirectional
        {{- end }}
        {{- if $enableGDRCopy }}
        - name: gdrcopy-validation
          image: {{ $image }}
          imagePullPolicy: IfNotPresent
          command: ["/usr/bin/nvidia-validator"]
          {{- include "helm_lib_module_container_security_context_privileged_read_only_root_filesystem" . | nindent 10 }}
          env:
            - name: COMPONENT
              value: gdrcopy
            - name: WITH_WAIT
              value: "true"
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: OUTPUT_DIR
              value: /run/nvidia/validations
          volumeMounts:
            - name: run-nvidia-validations
              mountPath: /run/nvidia/validations
              mountPropagation: Bidirectional
        {{- end }}
        - name: toolkit-validation
          image: {{ $image }}
          imagePullPolicy: IfNotPresent
          command: ["/usr/bin/nvidia-validator"]
          {{- include "helm_lib_module_container_security_context_privileged_read_only_root_filesystem" . | nindent 10 }}
          env:
            - name: COMPONENT
              value: toolkit
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: OUTPUT_DIR
              value: /run/nvidia/validations
          volumeMounts:
            - name: run-nvidia-validations
              mountPath: /run/nvidia/validations
              mountPropagation: Bidirectional
        - name: cuda-validation
          image: {{ $image }}
          imagePullPolicy: IfNotPresent
          command: ["/usr/bin/nvidia-validator"]
          {{- include "helm_lib_module_container_security_context_privileged_read_only_root_filesystem" . | nindent 10 }}
          env:
            - name: COMPONENT
              value: cuda
            - name: WITH_WAIT
              value: "false"
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: OUTPUT_DIR
              value: /run/nvidia/validations
            - name: VALIDATOR_IMAGE
              value: {{ $image | quote }}
            - name: VALIDATOR_IMAGE_PULL_POLICY
              value: {{ $validatorPullPolicy | quote }}
            - name: VALIDATOR_RUNTIME_CLASS
              value: {{ $runtimeClass | quote }}
          volumeMounts:
            - name: run-nvidia-validations
              mountPath: /run/nvidia/validations
              mountPropagation: Bidirectional
        - name: plugin-validation
          image: {{ $image }}
          imagePullPolicy: IfNotPresent
          command: ["/usr/bin/nvidia-validator"]
          {{- include "helm_lib_module_container_security_context_privileged_read_only_root_filesystem" . | nindent 10 }}
          env:
            - name: COMPONENT
              value: plugin
            - name: WITH_WAIT
              value: "false"
            - name: WITH_WORKLOAD
              value: "false"
            - name: MIG_STRATEGY
              value: {{ $migStrategy | quote }}
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: OUTPUT_DIR
              value: /run/nvidia/validations
            - name: VALIDATOR_IMAGE
              value: {{ $image | quote }}
            - name: VALIDATOR_IMAGE_PULL_POLICY
              value: {{ $validatorPullPolicy | quote }}
            - name: VALIDATOR_RUNTIME_CLASS
              value: {{ $runtimeClass | quote }}
          volumeMounts:
            - name: run-nvidia-validations
              mountPath: /run/nvidia/validations
              mountPropagation: Bidirectional
      containers:
        - name: watchdog
          image: {{ $image }}
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c", "echo all validations are successful; while true; do sleep 86400; done"]
          {{- include "helm_lib_module_container_security_context_privileged_read_only_root_filesystem" . | nindent 10 }}
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "rm -f /run/nvidia/validations/*-ready"]
          volumeMounts:
            - name: run-nvidia-validations
              mountPath: /run/nvidia/validations
              mountPropagation: Bidirectional
      volumes:
        - name: run-nvidia-validations
          hostPath:
            path: /run/nvidia/validations
            type: DirectoryOrCreate
        - name: driver-install-dir
          hostPath:
            path: /run/nvidia/driver
            type: DirectoryOrCreate
        - name: host-root
          hostPath:
            path: /
            type: Directory
        - name: host-dev-char
          hostPath:
            path: /dev/char
            type: Directory
{{- end }}
