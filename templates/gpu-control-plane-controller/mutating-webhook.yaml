{{- if eq (include "gpuControlPlane.isEnabled" .) "true" }}
{{- $ns := include "gpuControlPlane.namespace" . }}
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  {{- include "helm_lib_module_labels" (list . (dict "app" (include "gpuControlPlane.controllerName" .))) | nindent 2 }}
  name: {{ include "gpuControlPlane.controllerName" . }}-defaulter
webhooks:
  - name: gpupool.gpu-control-plane.deckhouse.io
    admissionReviewVersions: ["v1"]
    sideEffects: None
    failurePolicy: Fail
    reinvocationPolicy: IfNeeded
    rules:
      - apiGroups:   ["gpu.deckhouse.io"]
        apiVersions: ["v1alpha1"]
        operations:  ["CREATE", "UPDATE"]
        resources:   ["gpupools"]
        scope:       "Namespaced"
    clientConfig:
      service:
        namespace: {{ $ns }}
        name: {{ include "gpuControlPlane.controllerName" . }}
        path: /mutate-gpu-deckhouse-io-v1alpha1-gpupool
        port: 443
      caBundle: |
        {{ .Values.gpuControlPlane.internal.controller.cert.ca | b64enc }}
  - name: clustergpupool.gpu-control-plane.deckhouse.io
    admissionReviewVersions: ["v1"]
    sideEffects: None
    failurePolicy: Fail
    reinvocationPolicy: IfNeeded
    rules:
      - apiGroups:   ["gpu.deckhouse.io"]
        apiVersions: ["v1alpha1"]
        operations:  ["CREATE", "UPDATE"]
        resources:   ["clustergpupools"]
        scope:       "Cluster"
    clientConfig:
      service:
        namespace: {{ $ns }}
        name: {{ include "gpuControlPlane.controllerName" . }}
        path: /mutate-gpu-deckhouse-io-v1alpha1-clustergpupool
        port: 443
      caBundle: |
        {{ .Values.gpuControlPlane.internal.controller.cert.ca | b64enc }}
  - name: pod.gpu-control-plane.deckhouse.io
    admissionReviewVersions: ["v1"]
    sideEffects: None
    failurePolicy: Ignore
    reinvocationPolicy: IfNeeded
    namespaceSelector:
      matchExpressions:
        - key: gpu.deckhouse.io/enabled
          operator: In
          values: ["true"]
    objectSelector:
      matchExpressions:
        # Do not touch module pods and system services.
        - key: module
          operator: NotIn
          values: ["gpu-control-plane", "deckhouse"]
    rules:
      - apiGroups:   [""]
        apiVersions: ["v1"]
        operations:  ["CREATE", "UPDATE"]
        resources:   ["pods"]
        scope:       "Namespaced"
    clientConfig:
      service:
        namespace: {{ $ns }}
        name: {{ include "gpuControlPlane.controllerName" . }}
        path: /mutate--v1-pod
        port: 443
      caBundle: |
        {{ .Values.gpuControlPlane.internal.controller.cert.ca | b64enc }}
{{- end }}
