{{- $dcgm_version := "4.2.3" }}
{{- $deb_base := "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64" }}
{{- $packages := list
    (printf "datacenter-gpu-manager-4-core_%s_amd64.deb" $dcgm_version)
  }}
---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
fromImage: builder/golang-bookworm-1.24
final: false
shell:
  beforeInstall:
  - export DEBIAN_FRONTEND=noninteractive
  - apt-get update
  - apt-get install --assume-yes --no-install-recommends ca-certificates curl dpkg
  - rm -rf /var/lib/apt/lists/*
  install:
  - mkdir -p /pkg
  - |
    for pkg in {{ range $packages }}{{ . }} {{ end }}; do
      curl -sSL -o /tmp/${pkg} {{ $deb_base }}/$pkg
      dpkg-deb -x /tmp/${pkg} /pkg
      rm -f /tmp/${pkg}
    done
  - rm -rf /pkg/usr/share /pkg/usr/src /pkg/usr/include /pkg/usr/libexec/datacenter-gpu-manager-4/tests
  - rm -rf /pkg/usr/local
  - find /pkg -type f -name '*.a' -delete
  - |
    set -e
    mkdir -p /pkg/compat/lib /pkg/compat/lib64
    for lib in libc.so.6 libresolv.so.2 libpthread.so.0 librt.so.1 libdl.so.2 libm.so.6; do
      cp -L "/usr/lib/x86_64-linux-gnu/${lib}" /pkg/compat/lib/
    done
    cp -L "$(gcc -print-file-name=libgcc_s.so.1)" /pkg/compat/lib/
    cp -L /lib64/ld-linux-x86-64.so.2 /pkg/compat/lib64/
---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}
fromImage: {{ .ModuleNamePrefix }}distroless
import:
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
  add: /pkg/usr/bin
  to: /usr/bin
  before: setup
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
  add: /pkg/usr/libexec
  to: /usr/libexec
  before: setup
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
  add: /pkg/usr/lib/x86_64-linux-gnu
  to: /usr/lib/x86_64-linux-gnu
  before: setup
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
  add: /pkg/compat/lib
  to: /usr/lib
  before: setup
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
  add: /pkg/compat/lib64
  to: /lib64
  before: setup
imageSpec:
  config:
    entrypoint: ["/usr/bin/nv-hostengine"]
    cmd: ["-n", "-b", "0.0.0.0", "--log-level", "NONE", "-f", "-"]
    env:
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility,compat32"
      NVIDIA_DISABLE_REQUIRE: "true"
      NVIDIA_VISIBLE_DEVICES: "all"
      NO_SETCAP: ""
