{{- $dcgm_version := "4.2.3" }}
{{- $deb_base := "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64" }}
{{- $packages := list
    (printf "datacenter-gpu-manager-4-core_%s_amd64.deb" $dcgm_version)
    (printf "datacenter-gpu-manager-4-cuda12_%s_amd64.deb" $dcgm_version)
    (printf "datacenter-gpu-manager-4-proprietary-cuda12_%s_amd64.deb" $dcgm_version)
  }}
---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
fromImage: builder/golang-bookworm-1.24
final: false
shell:
  beforeInstall:
  - export DEBIAN_FRONTEND=noninteractive
  - apt-get update
  - apt-get install --assume-yes --no-install-recommends ca-certificates curl dpkg
  - rm -rf /var/lib/apt/lists/*
  install:
  - mkdir -p /pkg
  - |
    for pkg in {{ range $packages }}{{ . }} {{ end }}; do
      curl -sSL -o /tmp/${pkg} {{ $deb_base }}/$pkg
      dpkg-deb -x /tmp/${pkg} /pkg
      rm -f /tmp/${pkg}
    done
  - rm -rf /pkg/usr/share /pkg/usr/src /pkg/usr/include /pkg/usr/libexec/datacenter-gpu-manager-4/tests
  - find /pkg -type f -name '*.a' -delete
  - ln -sf /usr/lib64 /pkg/lib64
  - ln -sf /usr/lib /pkg/lib
---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}
fromImage: common/distroless
import:
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
  add: /pkg/usr
  to: /usr
  before: setup
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
  add: /pkg/lib64
  to: /lib64
  before: setup
- image: {{ .ModuleNamePrefix }}{{ .ImageName }}-package
  add: /pkg/lib
  to: /lib
  before: setup
imageSpec:
  config:
    entrypoint: ["/usr/bin/nv-hostengine"]
    cmd: ["-n", "-b", "0.0.0.0", "--log-level", "NONE", "-f", "-"]
    env:
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility,compat32"
      NVIDIA_DISABLE_REQUIRE: "true"
      NVIDIA_VISIBLE_DEVICES: "all"
      NO_SETCAP: ""
