---
image: {{ .ModuleNamePrefix }}{{ .ImageName }}
final: false
fromImage: builder/golang-bookworm-1.24
git:
  - add: {{ .ModuleDir }}/pkg
    to: /workspace/pkg
    stageDependencies:
      install:
        - go.mod
        - go.sum
      setup:
        - "**/*.go"
  - add: {{ .ModuleDir }}/src/controller
    to: /workspace/src/controller
    stageDependencies:
      install:
        - go.mod
        - go.sum
      setup:
        - "**/*.go"
secrets:
  - id: GOPROXY
    value: "{{ .GOPROXY }}"
mount:
  - fromPath: "~/go-pkg-cache"
    to: /go/pkg
shell:
  install:
    - export GOPROXY=$(cat /run/secrets/GOPROXY)
    - export GOTOOLCHAIN=go1.25.2
    - cd /workspace/src/controller
    - go mod download
  setup:
    - export GOTOOLCHAIN=go1.25.2
    - export GOOS=linux
    - export GOARCH=amd64
    - export CGO_ENABLED=0
    - cd /workspace/src/controller
    - mkdir -p /out
    - |
      {{- $_ := set $ "ProjectName" (printf "%s/controller" $.ImageName) -}}
      {{- include "image-build.build" (set $ "BuildCommand" `go build -trimpath -ldflags="-s -w" -o /out/gpu-control-plane-controller cmd/main.go`) | nindent 6 }}
