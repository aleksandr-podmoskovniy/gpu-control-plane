{{ $validatorVersion := "v25.3.4" }}
---
image: {{ .ModuleNamePrefix }}gpu-validator-artifact
final: false
fromImage: builder/golang-bookworm-1.24
secrets:
  - id: GOPROXY
    value: "{{ .GOPROXY }}"
  - id: SOURCE_REPO
    value: {{ .SOURCE_REPO }}
mount:
  - fromPath: "~/go-pkg-cache"
    to: /go/pkg
shell:
  install:
    - export GOPROXY=$(cat /run/secrets/GOPROXY)
    - go env -w GOPROXY=$GOPROXY
    - mkdir -p /src
  setup:
    - export GOPROXY=$(cat /run/secrets/GOPROXY)
    - export SOURCE_REPO=$(cat /run/secrets/SOURCE_REPO)
    - export GOOS=linux
    - export GOARCH=amd64
    - export CGO_ENABLED=0
    - git clone --depth 1 --branch {{ $validatorVersion }} ${SOURCE_REPO}/NVIDIA/gpu-operator.git /src/gpu-operator
    - mkdir -p /out
    - cd /src/gpu-operator/validator
    - |
      version_pkg="github.com/NVIDIA/gpu-operator/internal/info"
      validator_commit=$(git rev-parse HEAD)
      go build -trimpath -ldflags="-s -w -X ${version_pkg}.version={{ $validatorVersion }} -X ${version_pkg}.gitCommit=${validator_commit}" -o /out/nvidia-validator
    - mkdir -p /out/manifests
    - cp /src/gpu-operator/validator/*-workload-validation.yaml /out/manifests/
    - mkdir -p /out/validator
    - cp /src/gpu-operator/validator/versions.mk /out/validator/versions.mk
---
image: {{ .ModuleNamePrefix }}gpu-validator-runtime-artifact
final: false
fromImage: builder/alt
shell:
  beforeInstall:
  {{- include "alt packages proxy" . | nindent 2 }}
  - apt-get update
  - apt-get install -y glibc libstdc++6 libgcc1 libgomp1 libssl3 libnsl1 openssl
  {{- include "alt packages clean" . | nindent 2 }}
  install:
    - |
      set -euo pipefail
      mkdir -p /out/lib/x86_64-linux-gnu \
               /out/lib64 \
               /out/usr/lib/x86_64-linux-gnu \
               /out/usr/lib \
               /out/etc

      copy_lib() {
        local name="$1"
        for dir in /lib/x86_64-linux-gnu /usr/lib/x86_64-linux-gnu /lib64 /usr/lib64; do
          if [ -e "${dir}/${name}" ]; then
            cp -a "${dir}/${name}" /out/lib/x86_64-linux-gnu/
            return
          fi
        done
        echo "missing library: ${name}" >&2
        exit 1
      }

      for lib in \
        libBrokenLocale.so.1 \
        libanl.so.1 \
        libc.so.6 \
        libc_malloc_debug.so.0 \
        libdl.so.2 \
        libgcc_s.so.1 \
        libm.so.6 \
        libmvec.so.1 \
        libnsl.so.1 \
        libnss_compat.so.2 \
        libnss_dns.so.2 \
        libnss_files.so.2 \
        libnss_hesiod.so.2 \
        libpthread.so.0 \
        libresolv.so.2 \
        librt.so.1 \
        libthread_db.so.1 \
        libutil.so.1; do
        copy_lib "${lib}"
      done

      cp -a /lib64/ld-linux-x86-64.so.2 /out/lib64/

      cp -a /usr/lib64/libstdc++.so.6* /out/usr/lib/x86_64-linux-gnu/
      cp -a /usr/lib64/libgomp.so.1* /out/usr/lib/x86_64-linux-gnu/
      cp -a /usr/lib64/libcrypto.so.3 /out/usr/lib/x86_64-linux-gnu/
      cp -a /usr/lib64/libssl.so.3 /out/usr/lib/x86_64-linux-gnu/

      for dir in engines-3 ossl-modules gconv; do
        if [ -d "/usr/lib64/${dir}" ]; then
          cp -a "/usr/lib64/${dir}" /out/usr/lib/x86_64-linux-gnu/
        elif [ -d "/usr/lib/${dir}" ]; then
          cp -a "/usr/lib/${dir}" /out/usr/lib/x86_64-linux-gnu/
        else
          echo "skip optional directory: ${dir}" >&2
        fi
      done

      cp -a /usr/lib/os-release /out/usr/lib/
      cp -a /etc/ld.so.conf.d /out/etc/
---
image: {{ .ModuleNamePrefix }}gpu-validator-busybox-artifact
final: false
fromImage: builder/alpine
shell:
  install:
    - |
      set -euo pipefail
      apk add --no-cache busybox-static
      mkdir -p /out/bin /out/usr/bin
      busybox_path=""
      for candidate in /bin/busybox-static /bin/busybox.static /bin/busybox; do
        if [ -x "${candidate}" ]; then
          busybox_path="${candidate}"
          break
        fi
      done
      if [ -z "${busybox_path}" ]; then
        echo "busybox binary not found" >&2
        exit 1
      fi
      cp "${busybox_path}" /out/bin/busybox
      for link in sh tar ls cat env rm touch chroot; do
        ln -sf busybox "/out/bin/${link}"
        ln -sf /bin/busybox "/out/usr/bin/${link}"
      done
---
image: {{ .ModuleNamePrefix }}gpu-validator-vectoradd-artifact
final: false
fromImage: {{ .ModuleNamePrefix }}builder-cuda
secrets:
  - id: SOURCE_REPO
    value: {{ .SOURCE_REPO }}
import:
  - image: {{ .ModuleNamePrefix }}gpu-validator-artifact
    add: /out/validator/versions.mk
    to: /versions/versions.mk
    before: install
shell:
  install:
    - |
      set -euo pipefail
      export SOURCE_REPO=$(cat /run/secrets/SOURCE_REPO)
      cuda_samples_version="$(grep -E 'CUDA_SAMPLES_VERSION' /versions/versions.mk | tail -n1 | cut -d '=' -f2 | tr -d '[:space:]')"
      if [ -z "${cuda_samples_version}" ]; then
        echo "failed to detect CUDA_SAMPLES_VERSION, fallback to 11.7.1" >&2
        cuda_samples_version="11.7.1"
      fi
      git clone --depth 1 --branch "v${cuda_samples_version}" ${SOURCE_REPO}/NVIDIA/cuda-samples.git /src/cuda-samples
      cd /src/cuda-samples/Samples/0_Introduction/vectorAdd
      make
      mkdir -p /out
      cp vectorAdd /out/vectorAdd
---
image: {{ .ModuleNamePrefix }}gpu-validator
final: true
fromImage: {{ .ModuleNamePrefix }}distroless
import:
  - image: {{ .ModuleNamePrefix }}gpu-validator-artifact
    add: /out/nvidia-validator
    to: /usr/bin/nvidia-validator
    before: setup
  - image: {{ .ModuleNamePrefix }}gpu-validator-runtime-artifact
    add: /out/
    to: /
    before: setup
  - image: {{ .ModuleNamePrefix }}gpu-validator-busybox-artifact
    add: /out/bin/
    to: /bin
    before: setup
  - image: {{ .ModuleNamePrefix }}gpu-validator-busybox-artifact
    add: /out/usr/bin/
    to: /usr/bin
    before: setup
  - image: {{ .ModuleNamePrefix }}gpu-validator-vectoradd-artifact
    add: /out/vectorAdd
    to: /usr/bin/vectorAdd
    before: setup
  - image: {{ .ModuleNamePrefix }}gpu-validator-artifact
    add: /out/manifests/
    to: /var/nvidia/manifests
    before: setup
imageSpec:
  config:
    user: 0
    workingDir: /
    entrypoint: ["/usr/bin/nvidia-validator"]
    env:
      PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
