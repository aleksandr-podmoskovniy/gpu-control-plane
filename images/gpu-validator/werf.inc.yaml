{{ $validatorVersion := "v25.3.4" }}
---
image: {{ .ModuleNamePrefix }}gpu-validator-artifact
final: false
fromImage: builder/golang-bookworm-1.24
secrets:
  - id: GOPROXY
    value: "{{ .GOPROXY }}"
  - id: SOURCE_REPO
    value: {{ .SOURCE_REPO }}
mount:
  - fromPath: "~/go-pkg-cache"
    to: /go/pkg
shell:
  install:
    - export GOPROXY=$(cat /run/secrets/GOPROXY)
    - go env -w GOPROXY=$GOPROXY
    - mkdir -p /src
  setup:
    - export GOPROXY=$(cat /run/secrets/GOPROXY)
    - export SOURCE_REPO=$(cat /run/secrets/SOURCE_REPO)
    - export GOOS=linux
    - export GOARCH=amd64
    - export CGO_ENABLED=0
    - git clone --depth 1 --branch {{ $validatorVersion }} ${SOURCE_REPO}/NVIDIA/gpu-operator.git /src/gpu-operator
    - mkdir -p /out
    - cd /src/gpu-operator/validator
    - go build -trimpath -ldflags="-s -w" -o /out/nvidia-validator
---
image: {{ .ModuleNamePrefix }}gpu-validator
final: true
fromImage: {{ .ModuleNamePrefix }}distroless
import:
  - image: {{ .ModuleNamePrefix }}gpu-validator-artifact
    add: /out/nvidia-validator
    to: /usr/bin/nvidia-validator
    before: setup
  - image: builder/alpine
    add: /bin/busybox
    to: /bin/busybox
    before: setup
  - image: builder/alpine
    add: /bin/busybox
    to: /bin/sh
    before: setup
imageSpec:
  config:
    user: 0
    workingDir: /
    entrypoint: ["/usr/bin/nvidia-validator"]
    env:
      PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
